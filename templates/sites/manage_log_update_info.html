{% extends 'base.html' %}

{% load crispy_forms_tags %}

{% block title %} {{ site_name }}/{{ location_name }} {% endblock %}

{% block heading %}<h1 class="page-header"></h1>{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-lg-8">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">Log Update Info
                    </h4>
                </div>
                <div class="panel-body">{% crispy form %}</div>
            </div>
            <!-- /.panel-body -->
        </div>
        <!-- /.col-lg-8 -->
    </div>
    <!-- /.row -->
{% endblock %}

{% block extrajs %}
    <script type="text/javascript">
    $(document).ready(function () {
        var redirectToLocationUrl = '{% url 'sites:location_logs' %}';
        var siteName = '{{ site_name }}';
        var locationId = '{{ location_id }}';
        var locationName = '{{ location_name }}';
        var logId = '{{ log_id }}';
        var logName = '{{ log_name }}';

        redirectToLocationUrl += '?site_name=' + siteName + '&location_id=' + locationId
            + '&location_name=' + locationName;

        $('.page-header').text("Manage Log: " + logName);

        function setTimeFormatIdsField (timeFmtId) {
            var jsonLoggerTimeFormatUrl = '{% url 'sites:load_logger_time_format_json' %}' + '?json_request=' + true
                + '&logger_time_format_id=' + timeFmtId;
            $.getJSON(jsonLoggerTimeFormatUrl, function (TimeFormatData) {
                if (TimeFormatData.length > 0) {
                    loggerTimeIds = TimeFormatData[0].logger_time_ids;
                    $('#id_logger_time_format_time_ids').val(loggerTimeIds);
                    totalNumOfTimeIdFields = $('div[id^=div_id_log_time_format_time_id_]').length;
                    allocatedTimeIdFields = 0;
                    $.each(loggerTimeIds, function (i, timeId) {
                        $('#div_id_log_time_format_time_id_' + i).show();
                        $('#id_log_time_format_time_id_' + i).val(timeId);
                        allocatedTimeIdFields += 1;
                    });
                    while(allocatedTimeIdFields < totalNumOfTimeIdFields) {
                        $('#div_id_log_time_format_time_id_' + allocatedTimeIdFields).hide();
                        allocatedTimeIdFields += 1;
                    }
                }
            });
        }

        function showUpdateIntervalFields () {
            $('#div_id_update_interval').show();
                $('#id_update_interval').prop('required', true);
                if ($('#id_update_interval').val() == 'daily') {
                    $('#div_id_daily_interval').show();
                    $('#id_daily_interval').prop('required', true);
                    $('#div_id_hourly_interval').hide();
                    $('#id_hourly_interval').prop('required', false);
                }
                else if ($('#id_update_interval').val() == 'hourly') {
                    $('#div_id_hourly_interval').show();
                    $('#id_hourly_interval').prop('required', true);
                    $('#div_id_daily_interval').hide();
                    $('#id_daily_interval').prop('required', false);
                }
        }

        function hideUpdateIntervalFields () {
            $('#div_id_update_interval').hide();
            $('#id_update_interval').prop('required', false);
            $('#div_id_daily_interval').hide();
            $('#id_daily_interval').prop('required', false);
            $('#div_id_hourly_interval').hide();
            $('#id_hourly_interval').prop('required', false);
        }

        function checkInitFilePath() {
            logFilePath = $('#id_log_file_path').val();
            if (!logFilePath) {
                $('#id_log_file_path').parents('div .form-group').hide();
                $('#id_new_log_file_path').prop('required', true);
            }
        }

        function checkInitTimeFormat() {
            loggerTimeFormatId = $('#id_logger_time_format').val()
            if (loggerTimeFormatId) {
                setTimeFormatIdsField(loggerTimeFormatId);
            }
        }

        function checkInitUpdateInterval() {
            if ($('#id_update_is_active').is(":checked")) {
                showUpdateIntervalFields();
            }
            else {
                hideUpdateIntervalFields();
            }
        }

        $('#id-cancelBtn').on('click', function () {
            document.location.href = redirectToLocationUrl;
        });

        $('#id_update_is_active').on('click', function() {
            if ($(this).is(":checked")) {
                showUpdateIntervalFields();
            }
            else {
                hideUpdateIntervalFields();
            }
        });

        $('#id_update_interval').change(function () {
            if ($(this).val() == 'daily') {
                $('#div_id_daily_interval').show();
                $('#id_daily_interval').prop('required', true);
                $('#div_id_hourly_interval').hide();
                $('#id_hourly_interval').prop('required', false);
            }
            else if ($(this).val() == 'hourly') {
                $('#div_id_hourly_interval').show();
                $('#id_hourly_interval').prop('required', true);
                $('#div_id_daily_interval').hide();
                $('#id_daily_interval').prop('required', false);
            }
        });

        $('#id_logger_time_format').change(function () {
            loggerTimeFormatId = $(this).val();
            initSet = false;
            setTimeFormatIdsField(loggerTimeFormatId, initSet);
        });

    checkInitUpdateInterval();
    checkInitTimeFormat();
    checkInitFilePath();
    });
    </script>
{% endblock %}